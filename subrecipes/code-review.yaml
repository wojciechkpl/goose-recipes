version: "1.0.0"
title: "Code Review"
description: "Automated code review subrecipe that checks for language best practices, modularity, type safety, and common anti-patterns."

parameters:
  - key: target_path
    input_type: string
    requirement: required
    description: "File or directory path to review"
  - key: language
    input_type: select
    requirement: required
    description: "Programming language of the code"
    options:
      - python
      - dart
      - sql
  - key: review_focus
    input_type: select
    requirement: optional
    default: "general"
    description: "Specific focus area for the review"
    options:
      - general
      - security
      - performance
      - modularity

instructions: |
  You are an expert code reviewer. Review the code at {{ target_path }} with focus on {{ review_focus }}.

  ## Review Checklist

  ### Universal Checks
  - [ ] Functions/methods are under 30 lines (prefer under 20)
  - [ ] Classes have single responsibility
  - [ ] No hardcoded values — constants or config for magic numbers/strings
  - [ ] Error handling is explicit, not swallowed
  - [ ] No commented-out code left behind
  - [ ] Dependencies are injected, not created internally
  - [ ] Public APIs have documentation

  ### Python-Specific (if {{ language }} == python)
  - [ ] Type hints on ALL function signatures (PEP 484)
  - [ ] Pydantic models for request/response validation
  - [ ] `async def` for I/O-bound operations in FastAPI
  - [ ] No mutable default arguments
  - [ ] Context managers for resource management (`with` statements)
  - [ ] Logging via `logger` (not print statements)
  - [ ] SQLAlchemy queries use parameterized values (no f-string SQL)
  - [ ] Alembic migration exists for schema changes
  - [ ] pytest fixtures used instead of test setup duplication

  ### Dart/Flutter-Specific (if {{ language }} == dart)
  - [ ] No `dynamic` types — use strong typing or generics
  - [ ] Widgets decomposed (no build methods over 80 lines)
  - [ ] State management via Riverpod providers (not setState for complex state)
  - [ ] Freezed/immutable models for domain entities
  - [ ] `const` constructors where possible
  - [ ] go_router for navigation (no Navigator.push)
  - [ ] Proper error handling with AsyncValue in providers
  - [ ] Dispose/cancel subscriptions and controllers

  ### Focus: {{ review_focus }}
  - **general**: Full checklist above
  - **security**: Input validation, auth checks, SQL injection, secret exposure, CORS
  - **performance**: N+1 queries, unnecessary rebuilds, missing indexes, caching opportunities
  - **modularity**: Coupling analysis, dependency direction, interface boundaries, feature isolation

  ## Output Format
  Provide a structured review:
  1. **Critical Issues** (must fix before merge)
  2. **Warnings** (should fix, tech debt if not)
  3. **Suggestions** (nice-to-have improvements)
  4. **Positive Observations** (good patterns to reinforce)

prompt: "Review code at {{ target_path }} focusing on {{ review_focus }}"
